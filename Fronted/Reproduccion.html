<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproduciendo - VideITO</title>
    <!-- Incluye Tailwind CSS para un estilo moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para el player y la estructura */
        .video-player {
            aspect-ratio: 16 / 9;
            min-height: 300px;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .suggestion-thumbnail {
            width: 160px;
            height: 90px;
            min-width: 160px;
            background-size: cover;
            background-position: center;
            border-radius: 0.375rem;
            margin-right: 1rem;
        }
        .suggestion-item:hover {
            background-color: #f3f4f6;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #3b82f6;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }
        .dropdown-menu.show {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <!-- Encabezado Fijo y Responsivo (Header) -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center flex-wrap gap-4">
            <!-- Logo y Buscador -->
            <div class="flex items-center space-x-6 w-full md:w-auto">
                <a href="/" class="text-2xl font-bold text-blue-600 hover:text-blue-700 transition duration-150">VideITO</a>
                <div class="flex flex-grow max-w-md">
                    <input type="text" id="searchInput" placeholder="Buscar videos..." 
                           class="border border-gray-300 p-2 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500 flex-grow">
                    <button class="bg-blue-600 text-white p-2 rounded-r-lg hover:bg-blue-700 transition duration-150" 
                            onclick="buscarVideos()">
                        Buscar
                    </button>
                </div>
            </div>

            <!-- Ubicaci√≥n y Usuario -->
            <div class="flex items-center space-x-4">
                <div class="text-sm text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                    </svg>
                    Ubicaci√≥n: <span id="currentLocation" class="font-semibold text-gray-800">Oaxaca</span>
                </div>
                
                <!-- Men√∫ de Usuario (Autenticado) -->
                <div class="relative" id="userMenuContainer" style="display: none;">
                    <button class="flex items-center space-x-2 p-1 rounded-full hover:bg-gray-100 transition duration-150" id="userMenuButton">
                        <div class="user-avatar" id="userAvatarHeader"></div>
                        <span id="userName" class="text-sm font-medium hidden sm:inline">Usuario</span>
                    </button>
                    
                    <!-- Dropdown -->
                    <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden ring-1 ring-black ring-opacity-5" id="dropdownMenu">
                        <a href="/historial" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Historial</a>
                        <div class="border-t border-gray-100"></div>
                        <button class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50" onclick="cerrarSesion()">Salir</button>
                    </div>
                </div>

                <!-- Bot√≥n de Inicio de Sesi√≥n (No Autenticado) -->
                <div id="loginContainer" style="display: block;">
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition duration-150 shadow" 
                            onclick="iniciarSesionGoogle()">
                        Iniciar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Contenido Principal -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:flex lg:space-x-8">

        <!-- Secci√≥n del Reproductor y Descripci√≥n (Izquierda/Arriba) -->
        <div class="flex-grow min-w-0">
            <div class="player-section mb-6">
                <!-- Contenedor del Video Player -->
                <div class="video-player bg-gray-900" id="videoPlayer">
                    <div class="text-white">Cargando video...</div>
                </div>
            </div>

            <!-- Detalles del Video -->
            <div class="video-info-detailed bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <h1 class="text-xl sm:text-2xl font-bold mb-1" id="videoTitle">Cargando t√≠tulo...</h1>
                
                <div class="flex items-center text-sm text-gray-500 mb-4 space-x-4">
                    <span id="viewCount"></span>
                    <span id="publishDate"></span>
                </div>
                
                <!-- Info del Canal -->
                <div class="flex items-center border-t border-b py-3 mb-4">
                    <div class="channel-avatar text-lg mr-3" id="channelAvatar"></div>
                    <div class="channel-details flex-grow">
                        <div class="font-semibold text-lg" id="channelName">Cargando Canal...</div>
                    </div>
                </div>

                <!-- Descripci√≥n -->
                <div class="video-description-detailed text-gray-600 whitespace-pre-wrap" id="videoDescription">Cargando descripci√≥n...</div>
            </div>
        </div>

        <!-- Sugerencias (Derecha/Lateral) -->
        <div class="suggestions-section w-full lg:w-80 mt-8 lg:mt-0">
            <h3 class="text-xl font-bold mb-4">Sugerencias</h3>
            <div class="suggestions-list space-y-3" id="suggestionsList">
                <!-- Contenido cargado por JS -->
            </div>
        </div>
    </main>
    
    <!-- Script de YouTube Iframe API -->
    <script>
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    </script>

    <!-- Script de Firebase y L√≥gica de la Aplicaci√≥n -->
    <script type="module">
        // Importaciones modulares de Firebase (v11.6.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Inicializaci√≥n de Firebase con variables de entorno
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let player;
        let currentVideoInfo;
        let currentLocation = 'Oaxaca';
        let userId = null;

        // 1. Inicializar autenticaci√≥n
        async function initializeAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Error al autenticar:", e);
            }
        }

        // 2. Listener de estado de autenticaci√≥n
        onAuthStateChanged(auth, (user) => {
            userId = user ? user.uid : null;
            if (user) {
                document.getElementById('userMenuContainer').style.display = 'block';
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('userName').textContent = user.displayName || 'Usuario';
                
                // üî• CORRECCI√ìN CLAVE 1: Uso de backticks (template literal) para la URL de fondo üî•
                if (user.photoURL) {
                    document.getElementById('userAvatarHeader').style.backgroundImage = `url('${user.photoURL}')`;
                } else {
                    document.getElementById('userAvatarHeader').textContent = user.displayName ? user.displayName.charAt(0) : 'U';
                }
            } else {
                document.getElementById('userMenuContainer').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'block';
            }
        });

        // 3. Funciones de Autenticaci√≥n
        function iniciarSesionGoogle() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(e => console.error("Error de inicio de sesi√≥n:", e));
        }

        function cerrarSesion() {
            signOut(auth).then(() => window.location.reload()).catch(e => console.error("Error al cerrar sesi√≥n:", e));
        }

        window.iniciarSesionGoogle = iniciarSesionGoogle;
        window.cerrarSesion = cerrarSesion;

        // 4. L√≥gica de Reproducci√≥n (Se ejecuta cuando carga la API de YouTube)
        window.onYouTubeIframeAPIReady = function() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('v');
            
            if (params.get('location')) currentLocation = params.get('location');
            document.getElementById('currentLocation').textContent = currentLocation;
            
            if (id) {
                cargarReproductor(id);
                obtenerInfoYGuardar(id);
                cargarSugerencias(currentLocation);
            }
            initializeAuth(); // Iniciar autenticaci√≥n una vez que el entorno est√° listo
        };

        function cargarReproductor(id) {
            // üî• CORRECCI√ìN CLAVE 2: Uso de backticks (template literal) para el HTML interno üî•
            if (id.startsWith('vid_') || id.startsWith('demo_')) {
                document.getElementById('videoPlayer').innerHTML = `<div class="w-full h-full flex justify-center items-center text-white bg-gray-900 text-xl font-semibold">Video Demo (No reproducible)</div>`;
            } else {
                // Esto inicializa el reproductor de YouTube
                player = new YT.Player('videoPlayer', { 
                    height: '100%', 
                    width: '100%', 
                    videoId: id, 
                    playerVars: { 'autoplay': 1, 'modestbranding': 1 },
                    // El contenedor debe estar listo para recibir el iframe
                    host: 'https://www.youtube.com'
                });
            }
        }

        async function obtenerInfoYGuardar(id) {
            try {
                const res = await fetch(`/api/video-info?v=${id}`);
                const data = await res.json();
                const info = data.video || data;

                if (info && info.title) {
                    currentVideoInfo = info;
                    mostrarDetalles(info);
                    guardarEnHistorial(info);
                } else { throw new Error("No data"); }
            } catch(e) {
                console.error("Error al obtener info del video:", e);
                const demo = { id: id, title: "Video Demo / Info Desconocida", channelTitle: "Desconocido", description: "La informaci√≥n detallada del video no est√° disponible.", thumbnail: `https://placehold.co/300x200/cccccc/333333?text=Demo+Video` };
                mostrarDetalles(demo);
                guardarEnHistorial(demo);
            }
        }

        async function guardarEnHistorial(info) {
            if(!userId) return;
            
            console.log("Guardando en historial:", info.title);
            try {
                const docRef = doc(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'users', userId, 'historial', info.id);
                await setDoc(docRef, {
                    videoId: info.id,
                    title: info.title,
                    channelTitle: info.channelTitle,
                    thumbnail: info.thumbnail || `https://placehold.co/160x90/eeeeee/333333?text=Video`,
                    vistoPorUltimaVez: serverTimestamp()
                }, { merge: true });
            } catch(e) { console.error("Error al guardar historial:", e); }
        }

        function mostrarDetalles(v) {
            document.getElementById('videoTitle').textContent = v.title;
            document.getElementById('channelName').textContent = v.channelTitle;
            document.getElementById('videoDescription').textContent = v.description;
            
            // Stats mock/placeholder (ajusta si tu API los provee)
            document.getElementById('viewCount').textContent = v.viewCount ? `${v.viewCount} vistas` : 'N/A vistas';
            document.getElementById('publishDate').textContent = v.publishDate ? `‚Ä¢ Publicado el ${v.publishDate}` : '‚Ä¢ Fecha N/A';

            const avatarEl = document.getElementById('channelAvatar');
            if (avatarEl) {
                avatarEl.textContent = v.channelTitle ? v.channelTitle.charAt(0) : 'C';
            }
        }

        async function cargarSugerencias(loc) {
            try {
                const res = await fetch(`/api/videos?location=${loc}`);
                const data = await res.json();
                const videos = Array.isArray(data) ? data : data.videos;
                const suggestionsList = document.getElementById('suggestionsList');

                if(videos && suggestionsList) {
                    suggestionsList.innerHTML = videos.slice(0, 10).map(v => `
                        <div class="suggestion-item flex cursor-pointer p-2 rounded-lg transition duration-150" 
                             onclick="window.location.href='/reproduccion?v=${v.id}&location=${loc}'">
                            <div class="suggestion-thumbnail" style="background-image: url('${v.thumbnail || `https://placehold.co/160x90/eeeeee/333333?text=Video`}')"></div>
                            <div class="suggestion-info flex-grow">
                                <div class="text-sm font-semibold leading-snug line-clamp-2">${v.title}</div>
                                <div class="text-xs text-gray-500 mt-1">${v.channelTitle}</div>
                            </div>
                        </div>`).join('');
                }
            } catch(e) { console.error("Error al cargar sugerencias:", e); }
        }

        function buscarVideos() { 
            window.location.href = `/?search=${document.getElementById('searchInput').value}&location=${currentLocation}`; 
        }

        window.buscarVideos = buscarVideos;
        
        // Manejo del Dropdown
        document.getElementById('userMenuButton').addEventListener('click', (e) => { 
            e.stopPropagation(); 
            document.getElementById('dropdownMenu').classList.toggle('show'); 
        });
        window.addEventListener('click', () => document.getElementById('dropdownMenu').classList.remove('show'));

    </script>
</body>
</html>
